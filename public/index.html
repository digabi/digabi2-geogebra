<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <base href="/" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GeoGebra</title>
    <style>
      html {
        overflow: hidden;
      }
      .outer {
        display: flex;
        flex-direction: column;
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
      }
      .inner {
        flex: 1;
      }
      .GeoGebraFrame {
        border-width: 0 !important;
      }
      #saved-indicator {
        font-family: 'Arial', sans-serif;
        position: absolute;
        bottom: 5px;
        right: 5px;
        opacity: 0;
        transition: opacity 0.5s ease-in-out;
        color: #173e82;
        background: white;
        padding: 5px;
        font-size: 13px;
        letter-spacing: 0.5px;
      }
    </style>
  </head>
  <body>
    <div class="outer">
      <div class="inner">
        <div id="ggb-element"></div>
        <div id="saved-indicator" />
      </div>
    </div>
    <script src="GeoGebra/deployggb.js"></script>
    <script>
      // Lang query parameter is set by exam window container
      const search = new URLSearchParams(window.location.search)
      const lang = search.get('lang')
      localStorage.setItem('GeoGebraLangUI', lang)

      const config = new Map()
      const prefix = 'data:application/octet-stream;base64,'

      const path = () => `/wd/${encodeURIComponent(config.get('filename'))}`

      const savedIndicator = document.getElementById('saved-indicator')
      let saveTimeout = null

      async function getFile() {
        const propfindResponse = await fetch(path(), { method: 'PROPFIND' })
        if (propfindResponse.status !== 207) {
          return ''
        }
        const response = await fetch(path())
        const data = await response.arrayBuffer()
        const url = await new Promise((resolve, reject) => {
          const reader = new FileReader()
          reader.onload = () => resolve(reader.result)
          reader.onerror = () => reject(reader.error)
          reader.readAsDataURL(new File([data], '', { type: 'application/octet-stream' }))
        })
        return url.substring(prefix.length)
      }

      async function putFile(state) {
        savedIndicator.style.opacity = '0'
        const data = await fetch(`${prefix}${state}`)
        await fetch(path(), { method: 'PUT', body: await data.arrayBuffer() })

        switch (lang) {
          case 'fi-FI':
            savedIndicator.textContent = 'Tallennettu'
            break
          case 'sv-FI':
            savedIndicator.textContent = 'Sparat'
            break
          case 'en-Fi':
          default:
            savedIndicator.textContent = 'Saved'
            break
        }
        savedIndicator.style.opacity = '1'

        saveTimeout = setTimeout(() => {
          savedIndicator.style.opacity = '0'
        }, 2000)
      }

      function debounce(wait, callback) {
        let timeout
        return () => {
          window.clearTimeout(timeout)
          timeout = window.setTimeout(callback, wait)
        }
      }

      function debounceRepaint(callback) {
        let timeout
        return () => {
          window.cancelAnimationFrame(timeout)
          timeout = window.requestAnimationFrame(callback)
        }
      }

      const resize = debounce(1000 / 30, debounceRepaint(() => {
        if (window.ggbApplet) {
          ggbApplet.setSize(window.innerWidth, window.innerHeight)
        }
      }))

      async function onLoad(event) {
        const args = new URLSearchParams(window.location.search)
        config.set('filename', args.get('filename'))

        const ggbElement = document.getElementById('ggb-element')
        window.ggbElement = ggbElement

        const ggbParams = {
          appName: 'classic',
          showToolbar: true,
          showAlgebraInput: true,
          showMenuBar: true,
          enableFileFeatures: false,
          useBrowserForJs: true,
          disableAutoScale: true,
          perspective: '1',
          width: window.innerWidth,
          height: window.innerHeight,
          borderRadius: 0,
          ggbBase64: await getFile(),
          appletOnLoad() {
            resize()
          }
        }

        const applet = new GGBApplet(ggbParams, true)
        applet.setHTML5Codebase('GeoGebra/HTML5/5.0/web3d/')
        applet.inject(ggbElement.id)

        window.addEventListener('resize', resize)

        window.addEventListener('keydown', event => {
          if ((navigator.platform === 'MacIntel' ? event.metaKey : event.ctrlKey) && event.key === 's') {
            if (window.ggbApplet) {
              window.ggbApplet.getBase64(putFile)
            }
            event.preventDefault()
          }
        })

        setInterval(() => {
          if (window.ggbApplet && document.hasFocus()) {
            putFile(window.ggbApplet.getBase64())
          }
        }, 10_000)
      }

      window.addEventListener('load', onLoad)
    </script>
  </body>
</html>
